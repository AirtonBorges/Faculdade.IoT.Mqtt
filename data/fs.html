<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gerenciar arquivos â€” LittleFS</title>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box}
    /* Design tokens: default = light theme */
    :root{
      --bg: #f7f7fb;
      --surface: #ffffff;
      --text: #1f1f23;
      --muted: #6b6b7a;
      --primary: #6750a4;
      --on-primary: #ffffff;
      --card-border: rgba(0,0,0,0.04);
      --muted-border: rgba(0,0,0,0.06);
      --radius: 14px;
      --item-bg: linear-gradient(180deg, rgba(0,0,0,0.02), transparent);
      --btn-ghost-border: rgba(0,0,0,0.06);
      --danger: #b00020;
      --controls-bg: rgba(0,0,0,0.02);
      --controls-border: rgba(0,0,0,0.04);
    }
    /* Follow system dark preference when user hasn't chosen a theme */
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #070709;
        --surface: #0f0f12;
        --text: #e6e2ea;
        --muted: #bdb8c8;
        --primary: #c7b3ff;
        --on-primary: #211034;
        --card-border: rgba(255,255,255,0.06);
        --muted-border: rgba(255,255,255,0.12);
        --item-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
        --btn-ghost-border: rgba(255,255,255,0.08);
        --danger: #ff5252;
        --controls-bg: rgba(255,255,255,0.02);
        --controls-border: rgba(255,255,255,0.06);
      }
    }
    /* User override: explicit data-theme on <html> takes precedence */
    html[data-theme="dark"]{
      --bg: #070709;
      --surface: #0f0f12;
      --text: #e6e2ea;
      --muted: #bdb8c8;
      --primary: #c7b3ff;
      --on-primary: #211034;
      --card-border: rgba(255,255,255,0.06);
      --muted-border: rgba(255,255,255,0.12);
      --item-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --btn-ghost-border: rgba(255,255,255,0.08);
      --danger: #ff5252;
      --controls-bg: rgba(255,255,255,0.02);
      --controls-border: rgba(255,255,255,0.06);
    }
    /* Explicit light theme to override system dark when user chooses 'light' */
    html[data-theme="light"]{
      --bg: #f7f7fb;
      --surface: #ffffff;
      --text: #1f1f23;
      --muted: #6b6b7a;
      --primary: #6750a4;
      --on-primary: #ffffff;
      --card-border: rgba(0,0,0,0.04);
      --muted-border: rgba(0,0,0,0.06);
      --radius: 14px;
      --item-bg: linear-gradient(180deg, rgba(0,0,0,0.02), transparent);
      --btn-ghost-border: rgba(0,0,0,0.06);
      --danger: #b00020;
      --controls-bg: rgba(0,0,0,0.02);
      --controls-border: rgba(0,0,0,0.04);
    }
    html,body{height:100%;margin:0;font-family:'Google Sans', Roboto, Arial, sans-serif;background:var(--bg);color:var(--muted)}
    /* Strong override: html[data-theme="dark"] wins over prefers-color-scheme rules */
    /* (user override defined above) */
    .wrap{min-height:100%;display:flex;align-items:flex-start;justify-content:center;padding:28px}
    .panel{width:100%;max-width:820px;margin-top:24px}
    .card{background:var(--surface);border-radius:calc(var(--radius) + 6px);padding:18px;box-shadow:0 12px 40px rgba(16,16,24,0.09);border:1px solid var(--card-border);color:var(--text)}
    h1{margin:0 0 6px;font-size:18px;color:color-mix(in srgb, var(--primary) 80%, black 20%)}
    p.desc{margin:0 0 12px;font-size:13px}
    .list{margin-top:12px}
    .item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:var(--item-bg);margin-bottom:8px}
    .meta{display:flex;gap:12px;align-items:center}
    .filename{font-weight:400}
    .size{font-size:13px;color:var(--muted);font-weight:400}
    .controls{display:flex;align-items:center;background:var(--controls-bg);padding:0;border-radius:999px;border:1px solid var(--controls-border);overflow:hidden}
    .btn{background:var(--primary);color:var(--on-primary);padding:8px 14px;border:none;cursor:pointer;font-weight:400;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .btn.ghost{background:transparent;border:none;color:var(--primary);padding:8px 12px}
    .small{padding:6px 10px;min-width:56px}
    /* Integrated two-button pill: left = download, right = delete */
    .controls a.btn{border-radius:999px 0 0 999px;background:transparent;padding:8px 14px;display:inline-flex;align-items:center;justify-content:center;height:38px;margin:0}
    .controls button.danger{border-radius:0 999px 999px 0;background:var(--danger);color:#fff;padding:8px 14px;border:none;min-width:64px;display:inline-flex;align-items:center;justify-content:center;height:38px;margin:0}
    .controls button.danger{box-shadow:0 6px 18px rgba(0,0,0,0.18)}
    /* separator using border-left for better alignment */
    .controls button.danger{border-left:1px solid rgba(0,0,0,0.06)}
    @media (prefers-color-scheme: dark){ .controls button.danger{border-left:1px solid rgba(255,255,255,0.04)} }
    a.btn, a.link{ text-decoration: none; }
    /* shared helpers (inlined) */
    :root, body, .card, .title { transition: background-color 200ms ease, color 200ms ease, box-shadow 200ms ease; }
    .action-btn{display:inline-flex;align-items:center;gap:0.5rem;padding:0.6rem 1rem;border-radius:2rem;border:none;cursor:pointer;font-weight:400;font-size:clamp(0.95rem,3.5vw,1.05rem);align-self:center;white-space:nowrap;justify-content:center}
    .action-btn.filled{background:var(--primary);color:var(--on-primary);box-shadow:0 6px 18px rgba(98,0,238,0.12)}
    .action-btn.ghost{background:transparent;color:var(--primary);border:1px solid var(--muted-border);min-width:0;padding:0.6rem 1rem}
    body.dark .action-btn.ghost{border-color:var(--muted-border);color:var(--primary)}
    .action-btn:hover{transform:translateY(-3px);box-shadow:0 10px 24px rgba(0,0,0,0.08)}
    .muted{color:var(--muted);font-size:0.95rem}
    .small-note{margin-top:0.625rem;color:var(--muted);font-size:0.875rem;text-align:center}
    .hidden{display:none}
    /* theme button styling consistent with config.html */
    .theme-btn{background:var(--surface);border:1px solid var(--muted-border);color:var(--text);font-size:16px;cursor:pointer;padding:8px 10px;border-radius:8px;font-weight:500;white-space:nowrap;box-shadow:0 2px 6px rgba(0,0,0,0.06);transition:border-color 160ms, box-shadow 160ms, transform 120ms}
    html[data-theme="dark"] .theme-btn{color:var(--text)}
    .theme-btn:hover{border-color: rgba(98,0,238,0.18);box-shadow:0 6px 18px rgba(98,0,238,0.06)}
    .theme-btn:active{transform:translateY(1px)}
    .top-actions{display:flex;gap:8px;justify-content:flex-end;align-items:center}
    .top-actions .btn{border-radius:10px;padding:8px 12px}
    .top-actions .btn.ghost{background:transparent;border:1px solid var(--btn-ghost-border);color:var(--primary)}
    .top-actions .btn.small{background:var(--primary);color:var(--on-primary);box-shadow:0 6px 18px rgba(103,80,164,0.12)}
    /* Responsive adjustments */
    @media (max-width:900px){
      .panel{max-width:680px}
    }
    @media (max-width:700px){
      .wrap{padding:16px}
      .panel{max-width:100%}
      .card{padding:14px}
      h1{font-size:16px}
      .top-actions{gap:6px}
      .top-actions .btn{padding:7px 10px;font-size:14px}
      /* make items stack vertically on small screens */
      .item{flex-direction:column;align-items:stretch;padding:12px}
      .meta{display:flex;justify-content:space-between;gap:8px}
      .meta .filename{font-size:15px}
      .meta .size{font-size:12px}
      /* controls become full width but keep pill look */
      .controls{justify-content:flex-end}
      .controls a.btn{border-radius:10px 0 0 10px;padding:8px 12px;height:38px}
      .controls button.danger{border-radius:0 10px 10px 0;padding:8px 12px;height:38px}
      /* if narrow, make controls full width and buttons share space */
      @media (max-width:420px){
        .meta{flex-direction:column;align-items:flex-start}
        /* keep controls aligned to the right and prevent buttons from stretching */
        .controls{width:100%;margin-top:8px;justify-content:flex-end;gap:8px}
        .controls a.btn, .controls button.danger{flex:0 0 auto;margin:0;height:40px}
        .controls a.btn{border-radius:8px;padding:8px 10px;max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .controls button.danger{border-radius:8px;min-width:72px}
      }
    }
    .empty{padding:18px;text-align:center;color:var(--muted)}
    a.link{color:var(--primary);text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h1>Gerenciar arquivos (LittleFS)</h1>
            <p class="desc">Lista os arquivos armazenados no sistema de arquivos do dispositivo. VocÃª pode baixar ou apagar arquivos daqui.</p>
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <button id="theme-toggle" class="theme-btn" aria-label="Alternar tema">ðŸŒ™</button>
            <div class="top-actions">
              <a class="btn ghost" href="/">Voltar</a>
              <button id="refreshBtn" class="btn small">Atualizar</button>
              <button id="uploadBtn" class="btn small">Upload</button>
            </div>
          </div>
        </div>
        <div id="list" class="list" aria-live="polite">
          <div class="empty">Carregando...</div>
        </div>
        <div id="uploadArea" style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <input id="fileInput" type="file" style="display:none" />
          <div id="uploadStatus" class="muted">Arraste ou use o botÃ£o Upload para enviar arquivos.</div>
          <progress id="uploadProgress" value="0" max="100" style="display:none;width:160px"></progress>
        </div>
        <div style="margin-top:10px" class="muted">Dica: use o endpoint <code>/fs/delete?name=/arquivo</code> para apagar via navegador ou curl.</div>
      </div>
    </div>
  </div>
  <script>
    async function fetchList(){
      const el = document.getElementById('list');
      el.innerHTML = '<div class="empty">Carregando...</div>';
      try{
        const res = await fetch('/fs/list');
        if(!res.ok) throw new Error('Falha ao obter lista');
        const files = await res.json();
        if(!Array.isArray(files) || files.length === 0){ el.innerHTML = '<div class="empty">Nenhum arquivo encontrado</div>'; return; }
        el.innerHTML = '';
        files.forEach(f => {
          const item = document.createElement('div'); item.className = 'item';
          const meta = document.createElement('div'); meta.className = 'meta';
          const name = document.createElement('div'); name.className = 'filename'; name.textContent = f.name;
          const size = document.createElement('div'); size.className = 'size'; size.textContent = f.size + ' bytes';
          meta.appendChild(name); meta.appendChild(size);
          const controls = document.createElement('div'); controls.className = 'controls';
          const dl = document.createElement('a'); dl.className = 'btn small ghost'; dl.href = '/fs/download?name=' + encodeURIComponent(f.name); dl.textContent = 'Baixar';
          const del = document.createElement('button'); del.className = 'btn small danger'; del.textContent = 'Apagar';
          del.onclick = async () => {
            if(!confirm('Apagar "' + f.name + '"?')) return;
            try{
              const r = await fetch('/fs/delete?name=' + encodeURIComponent(f.name));
              if(r.ok){ alert('Arquivo apagado'); fetchList(); }
              else{ const t = await r.text(); alert('Erro: ' + t); }
            }catch(e){ alert('Erro: ' + e.message); }
          };
          controls.appendChild(dl); controls.appendChild(del);
          item.appendChild(meta); item.appendChild(controls);
          el.appendChild(item);
        });
      }catch(e){ el.innerHTML = '<div class="empty">Erro ao carregar: '+e.message+'</div>'; }
    }
    document.getElementById('refreshBtn').addEventListener('click', fetchList);
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const uploadStatus = document.getElementById('uploadStatus');
    const uploadProgress = document.getElementById('uploadProgress');

    uploadBtn.addEventListener('click', () => { fileInput.click(); });
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if(!file) return;
      uploadStatus.textContent = 'Enviando: ' + file.name;
      uploadProgress.style.display = 'inline-block';
      uploadProgress.value = 0;

      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/upload');
      xhr.upload.onprogress = function(e){
        if(e.lengthComputable){
          const pct = Math.round((e.loaded / e.total) * 100);
          uploadProgress.value = pct;
        }
      };
      xhr.onload = function(){
        uploadProgress.style.display = 'none';
        if(xhr.status >=200 && xhr.status < 300){
          uploadStatus.textContent = 'Upload concluÃ­do';
          fetchList();
        } else {
          uploadStatus.textContent = 'Erro no upload: ' + xhr.statusText;
        }
        // clear input to allow same file to be selected again
        fileInput.value = '';
      };
      xhr.onerror = function(){ uploadStatus.textContent = 'Falha na conexÃ£o durante upload'; uploadProgress.style.display = 'none'; };
      const fd = new FormData();
      fd.append('file', file, file.name);
      xhr.send(fd);
    });
    // initial load
    fetchList();
    // Theme toggle: persist and apply
    (function(){
      const btn = document.getElementById('theme-toggle');
      const apply = (mode)=>{
        if(mode === 'dark'){
          document.documentElement.setAttribute('data-theme','dark');
          try{ document.body.classList.add('dark'); }catch(e){}
        } else {
          document.documentElement.setAttribute('data-theme','light');
          try{ document.body.classList.remove('dark'); }catch(e){}
        }
        if(btn) btn.textContent = (mode === 'dark')? 'â˜€ï¸':'ðŸŒ™';
      };
      // initial: saved preference -> use it; otherwise follow system preference
      const stored = (function(){ try{ return localStorage.getItem('theme'); }catch(e){ return null; } })();
      if(stored) apply(stored);
      else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) apply('dark');
      else apply('light');
      if(btn){ btn.addEventListener('click', ()=>{
        const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        const next = (current === 'dark') ? 'light' : 'dark';
        try{ localStorage.setItem('theme', next); }catch(e){}
        apply(next);
      });
        // ensure pointer events even on some constrained UI stacks
        btn.style.pointerEvents = 'auto';
      }
      // if system preference changes and user hasn't chosen, follow it
      if(window.matchMedia){
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e=>{
          if(!localStorage.getItem('theme')) apply(e.matches? 'dark':'light');
        });
      }
    })();
  </script>
</body>
</html>